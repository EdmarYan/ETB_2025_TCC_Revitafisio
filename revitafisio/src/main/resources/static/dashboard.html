<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Revitafisio</title>
    <link rel="stylesheet" href="/vendor/bootstrap/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .welcome-jumbotron { background-color: #e9ecef; }
        #listaResultados a { text-decoration: none; }
        #listaResultados a:hover { text-decoration: underline; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-dark" data-bs-theme="dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard.html">Revitafisio</a>
        <ul class="navbar-nav ms-auto">
            <li class="nav-item">
                <a class="nav-link" href="#" id="logoutButton">Sair</a>
            </li>
        </ul>
    </div>
</nav>

<div class="container mt-4">
    <div class="p-5 mb-4 welcome-jumbotron rounded-3">
        <div class="container-fluid py-5">
            <h1 class="display-5 fw-bold" id="welcomeMessage">Bem-vindo(a)!</h1>
            <p class="col-md-8 fs-4">Gerencie pacientes, agendamentos e prontuários de forma eficiente.</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Pacientes</h5>
                    <p class="card-text">Adicione novos pacientes ao sistema ou busque por registros existentes.</p>
                    <a href="/cadastro-paciente.html" class="btn btn-primary">Cadastrar Novo Paciente</a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Funcionários</h5>
                    <p class="card-text">Gerencie os usuários do sistema, como fisioterapeutas e administradores.</p>
                    <a href="/cadastro-funcionario.html" class="btn btn-secondary">Cadastrar Novo Funcionário</a>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Buscar Paciente</h5>
            <form id="formBuscaPaciente">
                <div class="input-group">
                    <input type="text" class="form-control" id="nomeBusca" placeholder="Digite o nome do paciente para buscar..." required>
                    <button class="btn btn-outline-primary" type="submit">Buscar</button>
                </div>
            </form>
            <div class="mt-3" id="areaResultados">
                <ul class="list-group" id="listaResultados">
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // Esta função roda assim que a página carrega
    document.addEventListener('DOMContentLoaded', function() {
        const dadosUsuario = JSON.parse(localStorage.getItem('usuarioLogado'));

        if (!dadosUsuario || !dadosUsuario.nome) {
            window.location.href = '/';
        } else {
            document.getElementById('welcomeMessage').textContent = `Bem-vindo(a), ${dadosUsuario.nome}!`;
        }

        // Adiciona a funcionalidade de "Sair" ao botão
        document.getElementById('logoutButton').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('usuarioLogado');
            window.location.href = '/';
        });

        // Adiciona a funcionalidade de busca ao formulário
        document.getElementById('formBuscaPaciente').addEventListener('submit', function(e) {
            e.preventDefault();
            buscarPacientesPorNome();
        });

        // CHAMA A NOVA FUNÇÃO PARA CARREGAR OS PACIENTES INICIAIS
        carregarPacientesIniciais();
    });

    // NOVA FUNÇÃO para carregar todos os pacientes ao abrir a página
    async function carregarPacientesIniciais() {
        // Usamos a mesma lógica da busca, mas chamamos a API sem parâmetros
        await buscarPacientesNaApi('/pacientes');
    }

    // Função para buscar pacientes pelo nome digitado
    async function buscarPacientesPorNome() {
        const nome = document.getElementById('nomeBusca').value;
        if (nome.length < 2) {
            document.getElementById('listaResultados').innerHTML = '<li class="list-group-item">Digite ao menos 2 caracteres.</li>';
            return;
        }
        // Usamos a mesma lógica, mas passamos o nome como parâmetro
        await buscarPacientesNaApi(`/pacientes?nome=${encodeURIComponent(nome)}`);
    }

    // FUNÇÃO CENTRALIZADA para chamar a API e renderizar a lista
    async function buscarPacientesNaApi(url) {
        const listaResultados = document.getElementById('listaResultados');
        listaResultados.innerHTML = '<li class="list-group-item">Buscando...</li>';

        try {
            const response = await fetch(url);

            if (response.ok) {
                const pacientes = await response.json();
                listaResultados.innerHTML = '';

                if (pacientes.length > 0) {
                    pacientes.forEach(paciente => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            <div>
                                <strong>${paciente.nome}</strong>
                                <small class="d-block text-muted">CPF: ${paciente.cpf}</small>
                            </div>
                            <a href="/prontuario.html?pacienteId=${paciente.id}" class="btn btn-sm btn-outline-secondary">Ver Prontuário</a>
                        `;
                        listaResultados.appendChild(li);
                    });
                } else {
                    listaResultados.innerHTML = '<li class="list-group-item">Nenhum paciente encontrado.</li>';
                }
            } else {
                listaResultados.innerHTML = '<li class="list-group-item text-danger">Erro ao buscar pacientes.</li>';
            }
        } catch (error) {
            console.error("Erro na busca:", error);
            listaResultados.innerHTML = '<li class="list-group-item text-danger">Erro de conexão com a API.</li>';
        }
    }
</script>
</body>
</html>