<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Revitafisio</title>
    <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .welcome-jumbotron { background-color: #e9ecef; }
        .card-body {
            display: flex;
            flex-direction: column;
        }
        .card-body .btn-group, .card-body .btn {
            margin-top: auto; /* Alinha o botão na parte inferior do card */
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-dark" data-bs-theme="dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard.html">Revitafisio</a>
        <ul class="navbar-nav ms-auto">
            <li class="nav-item">
                <a class="nav-link" href="#" id="logoutButton">Sair</a>
            </li>
        </ul>
    </div>
</nav>

<div class="container mt-4">
    <div class="p-5 mb-4 welcome-jumbotron rounded-3">
        <div class="container-fluid py-5">
            <h1 class="display-5 fw-bold" id="welcomeMessage">Bem-vindo(a)!</h1>
            <p class="col-md-8 fs-4">Gerencie pacientes, agendamentos e prontuários de forma eficiente.</p>
        </div>
    </div>

    <div class="row mb-4 g-4">
        <div class="col-md-4" id="card-pacientes" style="display: none;">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Pacientes</h5>
                    <p class="card-text">Adicione novos pacientes ao sistema ou busque por registros existentes.</p>
                    <a href="/cadastro-paciente.html" class="btn btn-primary">Cadastrar Novo Paciente</a>
                </div>
            </div>
        </div>
        <div class="col-md-4" id="card-funcionarios" style="display: none;">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Equipe</h5>
                    <p class="card-text">Gerencie os usuários do sistema ou sua própria agenda de trabalho.</p>
                    <div class="btn-group" id="botoesFuncionario">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4" id="card-agenda" style="display: none;">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Agenda</h5>
                    <p class="card-text">Visualize, agende e gerencie as consultas da clínica.</p>
                    <a href="/agenda.html" class="btn btn-success">Acessar Agenda</a>
                </div>
            </div>
        </div>
        <div class="col-md-4" id="card-relatorios" style="display: none;">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Relatórios</h5>
                    <p class="card-text">Acesse dados e métricas de desempenho da clínica.</p>
                    <a href="/relatorios.html" class="btn btn-info">Ver Relatórios</a>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Buscar Paciente</h5>
            <form id="formBuscaPaciente">
                <div class="input-group">
                    <input type="text" class="form-control" id="nomeBusca" placeholder="Digite o nome do paciente para buscar...">
                    <button class="btn btn-outline-primary" type="submit">Buscar</button>
                </div>
            </form>
            <div class="mt-3" id="areaResultados">
                <ul class="list-group" id="listaResultados"></ul>
            </div>
        </div>
    </div>
</div>
<div class="toast-container position-fixed bottom-0 end-0 p-3">
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dadosUsuario = JSON.parse(localStorage.getItem('usuarioLogado'));

        if (!dadosUsuario || !dadosUsuario.nome) {
            window.location.href = '/';
            return;
        }

        document.getElementById('welcomeMessage').textContent = `Bem-vindo(a), ${dadosUsuario.nome}!`;

        configurarVisibilidade(dadosUsuario.tipoUsuario);

        document.getElementById('logoutButton').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('usuarioLogado');
            window.location.href = '/';
        });

        document.getElementById('formBuscaPaciente').addEventListener('submit', (e) => {
            e.preventDefault();
            buscarPacientesPorNome();
        });

        carregarPacientesIniciais();
    });

    function configurarVisibilidade(tipoUsuario) {
        const cardPacientes = document.getElementById('card-pacientes');
        const cardFuncionarios = document.getElementById('card-funcionarios');
        const cardAgenda = document.getElementById('card-agenda');
        const cardRelatorios = document.getElementById('card-relatorios');
        const botoesFuncionario = document.getElementById('botoesFuncionario');

        // Lógica de visibilidade dos cards
        if (tipoUsuario === 'ADMIN') {
            cardPacientes.style.display = 'block';
            cardFuncionarios.style.display = 'block';
            cardAgenda.style.display = 'block';
            cardRelatorios.style.display = 'block';
            botoesFuncionario.innerHTML = `
                <a href="/cadastro-funcionario.html" class="btn btn-primary">Cadastrar</a>
                <a href="/funcionarios.html" class="btn btn-secondary">Gerenciar</a>
            `;
        } else if (tipoUsuario === 'RECEPCIONISTA') {
            cardPacientes.style.display = 'block';
            cardAgenda.style.display = 'block';
        } else if (tipoUsuario === 'FISIOTERAPEUTA') {
            cardFuncionarios.style.display = 'block';
            cardAgenda.style.display = 'block';
            botoesFuncionario.innerHTML = `<a href="/meus-horarios.html" class="btn btn-info">Meus Horários de Trabalho</a>`;
        }
    }

    async function carregarPacientesIniciais() {
        await buscarPacientesNaApi('/pacientes');
    }

    async function buscarPacientesPorNome() {
        const nome = document.getElementById('nomeBusca').value;
        if (!nome || nome.length < 2) {
            carregarPacientesIniciais(); // Se a busca for vazia, carrega todos
            return;
        }
        await buscarPacientesNaApi(`/pacientes?nome=${encodeURIComponent(nome)}`);
    }

    async function buscarPacientesNaApi(url) {
        const listaResultados = document.getElementById('listaResultados');
        listaResultados.innerHTML = '<li class="list-group-item">Buscando...</li>';
        try {
            const response = await fetch(url);
            if (response.ok) {
                const pacientes = await response.json();
                listaResultados.innerHTML = '';
                if (pacientes.length > 0) {
                    pacientes.forEach(paciente => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            <div>
                                <strong>${paciente.nome}</strong>
                                <small class="d-block text-muted">CPF: ${paciente.cpf}</small>
                            </div>
                            <a href="/prontuario.html?pacienteId=${paciente.id}" class="btn btn-sm btn-outline-secondary">Ver Prontuário</a>
                        `;
                        listaResultados.appendChild(li);
                    });
                } else {
                    listaResultados.innerHTML = '<li class="list-group-item">Nenhum paciente encontrado.</li>';
                }
            } else {
                listaResultados.innerHTML = '<li class="list-group-item text-danger">Erro ao buscar pacientes.</li>';
            }
        } catch (error) {
            console.error("Erro na busca:", error);
            listaResultados.innerHTML = '<li class="list-group-item text-danger">Erro de conexão com a API.</li>';
        }
    }
</script>
</body>
</html>