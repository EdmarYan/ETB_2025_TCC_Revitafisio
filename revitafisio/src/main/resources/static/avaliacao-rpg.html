<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliação de RPG - Revitafisio</title>
    <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
</head>
<body>
<nav class="navbar navbar-expand-lg bg-dark" data-bs-theme="dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard.html">Revitafisio</a>
        <a id="voltarProntuario" class="btn btn-outline-light btn-sm">Voltar ao Prontuário</a>
    </div>
</nav>

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2>Ficha de Avaliação - RPG</h2>
        <h4 id="nomePaciente"></h4>
    </div>
    <hr>

    <form id="formAvaliacaoRpg">
        <fieldset class="mb-4">
            <legend class="h6">Anamnese e Diagnóstico</legend>
            <div class="row">
                <div class="col-md-12 mb-3"><label for="diagnostico_clinico" class="form-label">Diagnóstico Clínico</label><input type="text" id="diagnostico_clinico" name="diagnostico_clinico" class="form-control"></div>
                <div class="col-md-12 mb-3"><label for="hma" class="form-label">HMA</label><textarea id="hma" name="hma" rows="3" class="form-control"></textarea></div>
                <div class="col-md-6 mb-3"><label for="posicao_dor" class="form-label">Posição da Dor</label><input type="text" id="posicao_dor" name="posicao_dor" class="form-control"></div>
                <div class="col-md-6 mb-3"><label for="grau_dor" class="form-label">Grau da Dor</label>
                    <select id="grau_dor" name="grau_dor" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="LEVE">Leve</option>
                        <option value="MODERADA">Moderada</option>
                        <option value="INTENSA">Intensa</option>
                    </select>
                </div>
                <div class="col-md-12 mb-3"><label for="outras_patologias" class="form-label">Outras Patologias</label><textarea id="outras_patologias" name="outras_patologias" rows="2" class="form-control"></textarea></div>
                <div class="col-12 mb-3"><label class="form-label">Exames Complementares</label>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="ressonancia_magnetica" name="ressonancia_magnetica"><label class="form-check-label" for="ressonancia_magnetica">Ressonância</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="raio_x" name="raio_x"><label class="form-check-label" for="raio_x">Raio-X</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="tomografia" name="tomografia"><label class="form-check-label" for="tomografia">Tomografia</label></div>
                </div>
                <div class="col-md-12 mb-3"><label for="outros_exames" class="form-label">Outros Exames</label><input type="text" id="outros_exames" name="outros_exames" class="form-control"></div>
                <div class="col-12 mb-3"><label class="form-label">Uso de Medicamentos?</label>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="uso_medicamentos" name="uso_medicamentos"><label class="form-check-label" for="uso_medicamentos">Sim</label></div>
                </div>
                <div class="col-md-12 mb-3"><label for="medicamentos_descricao" class="form-label">Quais Medicamentos?</label><input type="text" id="medicamentos_descricao" name="medicamentos_descricao" class="form-control"></div>
            </div>
        </fieldset>

        <fieldset class="mb-4">
            <legend class="h6">Avaliação Postural</legend>
            <div class="row">
                <div class="col-md-4 mb-3"><label for="cabeca" class="form-label">Cabeça</label>
                    <select id="cabeca" name="cabeca" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="ALINHADA">Alinhada</option>
                        <option value="RODADA_DIREITA">Rodada à Direita</option>
                        <option value="RODADA_ESQUERDA">Rodada à Esquerda</option>
                        <option value="INCLINADA_DIREITA">Inclinada à Direita</option>
                        <option value="INCLINADA_ESQUERDA">Inclinada à Esquerda</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3"><label for="ombros" class="form-label">Nivelamento dos Ombros</label>
                    <select id="ombros" name="ombros" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="NIVELADOS">Nivelados</option>
                        <option value="ESQUERDO_ELEVADO">Esquerdo Elevado</option>
                        <option value="DIREITO_ELEVADO">Direito Elevado</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3"><label for="escapulas" class="form-label">Posição das Escápulas</label>
                    <select id="escapulas" name="escapulas" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="DIREITA_ALTA">Direita Alta</option>
                        <option value="ESQUERDA_ALTA">Esquerda Alta</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3"><label for="maos" class="form-label">Simetria das Mãos</label>
                    <select id="maos" name="maos" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="SIMETRICOS">Simétricos</option>
                        <option value="DIREITA_ALTA">Direita Alta</option>
                        <option value="ESQUERDA_ALTA">Esquerda Alta</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3"><label for="eias" class="form-label">Simetria EIAS</label>
                    <select id="eias" name="eias" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="SIMETRICAS">Simétricas</option>
                        <option value="DIREITA_ALTA">Direita Alta</option>
                        <option value="ESQUERDA_ALTA">Esquerda Alta</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3"><label for="pelve" class="form-label">Posição da Pelve</label>
                    <select id="pelve" name="pelve" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="NORMAL">Normal</option>
                        <option value="ANTEVERSÃO">Anterversão</option>
                        <option value="RETROVERSÃO">Retroversão</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3"><label for="joelhos" class="form-label">Posição dos Joelhos</label>
                    <select id="joelhos" name="joelhos" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="NORMAL">Normal</option>
                        <option value="VALGO">Valgo</option>
                        <option value="VARO">Varo</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3"><label for="lombar" class="form-label">Curvatura Lombar</label>
                    <select id="lombar" name="lombar" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="NORMAL">Normal</option>
                        <option value="HIPERLORDOSE">Hiperlordose</option>
                        <option value="RETIFICADA">Retificada</option>
                    </select>
                </div>
                <div class="col-md-12 mb-3"><label for="outros_desequilibrios" class="form-label">Outros Desequilíbrios</label><textarea id="outros_desequilibrios" name="outros_desequilibrios" rows="3" class="form-control"></textarea></div>
            </div>
        </fieldset>

        <fieldset>
            <legend class="h6">Plano de Tratamento</legend>
            <div class="mb-3"><label for="tratamento_proposto" class="form-label">Tratamento Proposto</label><textarea id="tratamento_proposto" name="tratamento_proposto" rows="4" class="form-control"></textarea></div>
            <div class="mb-3"><label for="observacoes" class="form-label">Observações Gerais</label><textarea id="observacoes" name="observacoes" rows="3" class="form-control"></textarea></div>
        </fieldset>

        <div id="resultado" class="my-3"></div>
        <button type="submit" class="btn btn-primary btn-lg">Salvar Avaliação de RPG</button>
    </form>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const pacienteId = urlParams.get('pacienteId');
    const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));

    document.addEventListener('DOMContentLoaded', function() {
        if (!pacienteId || !usuarioLogado) {
            alert('Dados insuficientes para carregar a página.');
            window.location.href = '/dashboard.html';
            return;
        }

        document.getElementById('voltarProntuario').href = `/prontuario.html?pacienteId=${pacienteId}`;
        document.getElementById('formAvaliacaoRpg').addEventListener('submit', salvar);
        carregarDados();
    });

    async function carregarDados() {
        fetch(`/pacientes/${pacienteId}`).then(res => res.json()).then(paciente => {
            document.getElementById('nomePaciente').textContent = `Paciente: ${paciente.nome}`;
        });

        const response = await fetch(`/avaliacoes/rpg/paciente/${pacienteId}`);
        if (response.ok) {
            const data = await response.json();
            preencherFormulario(data);
        }
    }

    function preencherFormulario(data) {
        // Preenche campos de texto e selects
        for (const key in data) {
            const element = document.getElementById(key);
            if (element && element.type !== 'checkbox') {
                element.value = data[key];
            }
        }
        // Preenche checkboxes
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            if (data[cb.name]) {
                cb.checked = true;
            }
        });
    }

    async function salvar(event) {
        event.preventDefault();
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.innerHTML = '';

        const form = document.getElementById('formAvaliacaoRpg');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Converte os valores dos checkboxes (que podem ser 'on' ou ausentes) para booleanos
        data.ressonancia_magnetica = document.getElementById('ressonancia_magnetica').checked;
        data.raio_x = document.getElementById('raio_x').checked;
        data.tomografia = document.getElementById('tomografia').checked;
        data.uso_medicamentos = document.getElementById('uso_medicamentos').checked;

        data.idPaciente = parseInt(pacienteId);
        data.idFisioterapeuta = usuarioLogado.usuarioId;

        try {
            const response = await fetch('/avaliacoes/rpg', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error('Falha ao salvar avaliação de RPG.');
            resultadoDiv.innerHTML = '<div class="alert alert-success">Avaliação salva com sucesso!</div>';
        } catch(error) {
            resultadoDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }
</script>
</body>
</html>